<html>
 <head>
  <meta charset="UTF-8">
  <title>WaveDrom Editor</title>
  <link rel="shortcut icon" href="images/favicon.ico"/>
  <link href='http://fonts.googleapis.com/css?family=Ubuntu+Mono' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="css/codemirror.css">
  <link rel="stylesheet" href="css/dialog.css">
  <link rel="stylesheet" href="css/main.css">

  <script src="scripts/codemirror-compressed.js"></script>
  <script src="scripts/lodash.min.js"></script>
  <script src="skins/default.js"></script>
  <script src="skins/narrow.js"></script>
  <script src="WaveDrom.js"></script>

<script>

    function editorState (op) {
        "use strict";
        var rot, drot, per, dper, sizeTXT, sizeSVG, styleTXT, styleSVG;

        function delta (root, name) {
            if (root && root[name]) {
                var res = Number (root[name]);
                if ((res !== 1) && (res !== -1)) { return 0; }
                return res;
            }
            return 0;
        }

        function ring (name, delta, size, init) {
            var res;
            res = parseInt (localStorage [name]);
            if (res || res === 0) {
                res += delta;
                if (res >= size) {
                    res -= size;
                } else if (res < 0) {
                    res += size;
                }
            } else {
                res = init;
            }
            localStorage [name] = res;
            return res;
        }

        function setStyle (id, prop) {
            var e = document.getElementById (id);
            e.removeAttribute("style");
            for (var p in prop) {
                e.style [p] = prop [p];
            }
        }

        drot = delta (op, 'rot');
        dper = delta (op, 'per');
        rot  = ring  ('drom.editor.rot', drot, 4, 0);
        per  = ring  ('drom.editor.per', dper, 7, 3);
        sizeTXT = ((per + 2) * 10) + '%';
        sizeSVG = ((8 - per) * 10) + '%';

        if (rot === 1) {        // SVG|TXT
            styleSVG = {width: sizeSVG, height: '100%', cssFloat: 'left', overflow: 'hidden'};
            styleTXT = {                height: '100%'};
        } else if (rot === 2) { // SVG/TXT
            styleSVG = {width: '100%', height: sizeSVG, overflow: 'hidden'};
            styleTXT = {height: sizeTXT};
        } else if (rot === 3) { // TXT|SVG
            styleSVG = {width: sizeSVG, height: '100%', cssFloat: 'right', overflow: 'hidden'};
            styleTXT = {width: sizeTXT, height: '100%'};
        } else {                // TXT/SVG
            styleSVG = {width: '100%', height: sizeSVG, position: 'absolute', bottom: 0, overflow: 'hidden'};
            styleTXT = {height: sizeTXT};
        }
        setStyle('SVG', styleSVG);
        setStyle('TXT', styleTXT);
        WaveDrom.EditorRefresh();
    }

    function editorInit () {
        "use strict";
        if (document.location.search) {
          cm.setValue(decodeURIComponent(window.location.search.substr(1)));
          // document.getElementById ('InputJSON_0').value = decodeURIComponent(window.location.search.substr(1));
        }
        window.ondragover = function(e) { e.preventDefault(); return false };
        window.ondrop = function(e) { e.preventDefault(); return false };

        if (typeof process == "object") { // nodewebkit detection
          var holder = document.getElementById('content');
          holder.ondragover = function () { this.className = 'hover'; return false; };
          holder.ondragend = function () { this.className = ''; return false; };
          holder.ondrop = function (e) {
            e.preventDefault();

            for (var i = 0; i < e.dataTransfer.files.length; ++i) {
              console.log(e.dataTransfer.files[i].path);
            }
            return false;
          };
        }
        editorState ();
    }

    function setFullURL () {
        "use strict";
        document.location.search = encodeURIComponent(document.getElementById ('InputJSON_0').value);
    }

    function menuOpen (e) {
      "use strict";
      function closestById(el, id) {
        while (el.id != id) {
          el = el.parentNode;
          if (!el) {
              return null;
          }
        }
        return el;
      }

      var doc = document.getElementById ('menux');
      if ( closestById ( e.target, 'Menu' ) && ( doc.style.display === "none" ) ) {
        doc.style.display = "inline";
      } else {
        doc.style.display = "none";
      }
    }

    function gotoWaveDromHome (e) {
      window.open("https://wavedrom.com").focus();
    }

    function gotoWaveDromGuide (e) {
      window.open("tutorial.html").focus();
    }

    function saveJSON (e) {
        var sjson = localStorage.waveform,
            a = document.createElement('a');

        function chooseFile(name) {
            var chooser = document.querySelector(name);

            chooser.addEventListener("change", function(evt) {
                var fs = require('fs');
                var filename = this.value;
                if (!filename) { return; }
                fs.writeFile(filename, sjson, function(err) {
                    if(err) {
                        alert("error");
                    }
                });
                this.value = '';
            }, false);

            chooser.click();
        }

        if (typeof process == "object") { // nodewebkit detection
            chooseFile('#fileDialog');
        } else {
            a.href = 'data:text/json;base64,' + btoa(sjson);
            a.download = 'wavedrom.json';
            var theEvent = document.createEvent("MouseEvent");
            theEvent.initMouseEvent("click", true, true, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
            a.dispatchEvent(theEvent);
            // a.click();
        }
    }

    function saveSVG (e) {
        var svg, ser, ssvg, a;

        svg = document.getElementById("svgcontent_0");
        ser = new XMLSerializer();
        ssvg = '<?xml version="1.0" standalone="no"?>\n'
            + '<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">\n'
            + '<!-- Created with WaveDrom -->\n'
            + ser.serializeToString(svg);

        function chooseFile(name) {
            var chooser = document.querySelector(name);

            chooser.addEventListener("change", function(evt) {
                var fs = require('fs');
                var filename = this.value;
                if (!filename) { return; }
                fs.writeFile(filename, ssvg, function(err) {
                    if(err) {
                        alert("error");
                    }
                });
                this.value = '';
            }, false);
            chooser.click();
        }

        if (typeof process == "object") { // nodewebkit detection
            chooseFile('#fileDialogSVG');
        } else {
            a = document.createElement('a');
            a.href = 'data:image/svg+xml;base64,' + btoa(ssvg);
            a.download = 'wavedrom.svg';
            var theEvent = document.createEvent("MouseEvent");
            theEvent.initMouseEvent("click", true, true, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
            a.dispatchEvent(theEvent);
            // a.click();
        }
    }

    function savePNG (e) {
        var svg, ser, ssvg, svgdata, img, canvas, context, pngdata, a;

        svg = document.getElementById("svgcontent_0");
        ser = new XMLSerializer();
        ssvg = '<?xml version="1.0" standalone="no"?>\n'
            + '<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">\n'
            + '<!-- Created with WaveDrom -->\n'
            + ser.serializeToString(svg);

        svgdata = 'data:image/svg+xml;base64,' + btoa(ssvg);
        img = new Image ();
        img.src = svgdata;
        canvas = document.createElement('canvas');
        canvas.width = img.width;
        canvas.height = img.height;
        context = canvas.getContext('2d');
        context.drawImage(img, 0, 0);
        pngdata = canvas.toDataURL('image/png');

        function chooseFile(name) {
            var chooser = document.querySelector(name);

            chooser.addEventListener("change", function(evt) {
                var fs = require('fs');
                var filename = this.value;
                if (!filename) { return; }
                var data = pngdata.replace(/^data:image\/\w+;base64,/, "");
                var buf = new Buffer(data, 'base64');
                fs.writeFile(filename, buf, function(err) {
                    if(err) {
                        alert("error");
                    }
                });
                this.value = '';
            }, false);
            chooser.click();
        }

        if (typeof process == "object") { // nodewebkit detection
            chooseFile('#fileDialogPNG');
        } else {
            a = document.createElement('a');
            a.href = pngdata;
            a.download = 'wavedrom.png';
            var theEvent = document.createEvent("MouseEvent");
            theEvent.initMouseEvent("click", true, true, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
            a.dispatchEvent(theEvent);
            // a.click();
        }
    }

</script>
</head>

  <body onload="editorInit()" onclick="menuOpen(event)">
    <div id="content">
      <div class="toolbar">
        <img class="button" alt="Memu" id="Menu" title="Menu" src="images/ic_menu.png"/>
      </div>
      <div style="display:none;" class="menu" id="menux">
        <ul>
          <!--li>New</li>
          <li>Open...</li>
          <li>Save</li-->
          <li onclick="saveJSON(event)"> <img class="button" src="images/ic_download_json.png"/> Save As... </li>
          <li onclick="saveSVG(event)"> <img class="button" src="images/ic_download_svg.png"/> Export SVG... </li>
          <li onclick="savePNG(event)"> <img class="button" src="images/ic_download_png.png"/> Export PNG... </li>
        </ul>
        <ul>
          <li onclick="editorState({rot:1})"> <img class="button" src="images/ic_rot.png" /> Rotate Layout </li>
          <li onclick="editorState({per:1})"> <img class="button" src="images/ic_persent.png" /> Proportions </li>
          <li onclick="setFullURL()"> <img class="button" src="images/ic_url.png"/> Expand URL </li>
          <li onclick="gotoWaveDromGuide()" id="WaveDromGuide"> <img class="button" src="images/ic_guide.png"/> WaveDrom Guide </li>
          <li onclick="gotoWaveDromHome()"  id="WaveDromHome"> <img class="button" src="images/ic_logo.png"/> on GitHub </li>
          <li style="display:none;">Exit</li>
        </ul>
      </div>
      <input style="display:none;" id="fileDialog" type="file" nwsaveas="wavedrom.json" />
      <input style="display:none;" id="fileDialogSVG" type="file" nwsaveas="wavedrom.svg" />
      <input style="display:none;" id="fileDialogPNG" type="file" nwsaveas="wavedrom.png" />
      <div id='SVG'><div id="WaveDrom_Display_0"></div></div>
      <div id='TXT'><textarea id="InputJSON_0"></textarea></div>
    </div>
  <script type="text/javascript">
    (function KillBill () {
      if (navigator.appName.indexOf('Explorer') >= 0) {
        var e = document.getElementById('content');
        e.parentNode.removeChild(e);
        document.write("<h1>Sorry, Internet Explorer is not supported.</h1>");
        document.body.style.backgroundColor = '#ffdddd';
        window.stop();
      }
    })();
  </script>
  <script>
    var e, val, timer, isNodeWebkit;
    e = document.getElementById ('InputJSON_0');
    val = localStorage ['waveform'];
            // node-webkit detection
    isNodeWebkit = (typeof process == "object");

    if (isNodeWebkit || val === undefined || val === '') {
        val = "{signal: [\n  {name: 'clk', wave: 'p.....|...'},\n  {name: 'dat', wave: 'x.345x|=.x', data: ['head', 'body', 'tail', 'data']},\n  {name: 'req', wave: '0.1..0|1.0'},\n  {},\n  {name: 'ack', wave: '1.....|01.'}\n]}\n";
        localStorage ['waveform'] = val;
    }
    e.value = val;
    var cm = CodeMirror.fromTextArea (e, {lineNumbers: true, mode: {name: 'javascript', json: true}, matchBrackets: true, autoCloseBrackets: true, highlightSelectionMatche: true, autofocus: true});
    cm.on ("change", function (cm, change) {
        function c () {
            var v = cm.getValue();
            e.value = v;
            localStorage ['waveform'] = v;
            WaveDrom.EditorRefresh ();
        }
        timer = setTimeout (c, 750);
    });
  </script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-21660728-3', 'auto');
  ga('send', 'pageview');

</script>

</body>
</html>
